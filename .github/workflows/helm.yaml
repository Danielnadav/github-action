name: Kubernetes Workflow

on: [push]

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Install Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod +x get_helm.sh
          ./get_helm.sh

  get-pods:
    name: Get pods
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Install and configure kubectl
        run: |
          VERSION=$(curl --silent https://storage.googleapis.com/kubernetes-release/release/stable.txt)
          curl https://storage.googleapis.com/kubernetes-release/release/$VERSION/bin/linux/amd64/kubectl \
              --progress-bar \
              --location \
              --remote-name
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > kubeconfig.yaml

      - name: Set KUBECONFIG
        run: |
          echo "KUBECONFIG=${{ github.workspace }}/kubeconfig.yaml" >> $GITHUB_ENV

      - uses: actions-hub/kubectl@master
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig.yaml
        with:
          args: get pods
